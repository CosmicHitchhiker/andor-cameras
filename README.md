### andor-cameras
# Управление камерами Andor

## Общее описание
Данная программа создана с целью облегчить написание системы управления 
приборами Кавказской Горной Обсерватории (в частности - 60см телескопом и 
двухканальным спектрографом на 2.5-метровом телескопе). Программа берёт на 
себя управление камерами Андор, а именно:

*   Инициализация камеры с заданными параметрами
*   Постоянный мониторинг и запись в файл состояния камеры
*   Контроль температурного режима камеры
*   Контроль затвора камеры
*   Контроль получения камерой изображения
*   Настройка результирующих fits-файлов

Программа работает как демон, общение с программой осуществляется через TCP 
протокол. Всё время выполнения программа ведёт лог с подробным описанием всех 
действий и событий. В данный момент программа поддерживает только операционные 
системы семейства linux.


## Использование программы
### Подготовка к запуску

Создайте *.ini* файл с параметрами запуска программы в папке, где лежит
программа.  Файл должен представлятьиз себя скрипт, написанный на языке
общения с демоном (подробнее в разделе **Файл конфигурации**).  Имя файла
должно соответствовать имени подключённой камеры.  В нём должны быть указаны
номер порта, на котором будет запущен TCP сервер, а также, если это
требуется, первичные команды для камеры (температура, постоянные значения
шапки сохраняемых в дальнейшем fits-файлов etc.)

Перед запуском программы следует убедиться, что желаемый TCP порт свободен,
камера подключена и распознаётся компьютером.
Проверить, распознаётся ли камера, можно, например, командой ```lsusb```.

### Работа с программой
После того, как выполнены все требования, описанные в предыдущем разделе, 
можно запустить программу из терминала, перейдя в папку с программой и набрав 
в терминале
```
./andor-daemon
``` 
Через пару секунд программа выведет в терминал сообщение с PID
созданного демона и перейдёт в режим демона.  Первые секунды работы
программы стоит просматривать лог-файл (создаётся автоматически с
расширением *.log*) на предмет ошибок.  Если всё прошло успешно, лог-файл
будет содержать строку "*Client connected*".  Обычно запуск
программы занимает около 5 секунд.  В это время происходит инициализация
камеры, запуск TCP сервера (**если порт не указан в файле конфигурации,
будет использован порт по умолчанию: 1567**), создание шаблонного заголовка fits-файла,
считывание информации о состоянии камеры и запись этой информации в *.info*
файл, а также выполнение остальных комманд из *.ini* файла.
Если к компьютеру подключены несколько камер, определить к какой
именно из них подключилась программа также можно в лог-файле.

После того, как программа перешла в режим ожидания команды пользователя, с
нею возможно общение по TCP протоколу на заданном порту.  В настоящий момент
возможны следующие команды:

*   Запустить съёмку с заданной выдержкой
*   Прервать текущую съёмку
*   Добавить строку в заголовок fits-файла
*   Задать желаемую температуру камеры
*   Изменить режим затвора (автоматический/закрытый/открытый)
*   Изменить директорию сохранения файлов
*   Изменить суффикс/префикс имён сохраняемых файлов
*   Задать бинирование по осям
*   Задать рабочую область матрицы (кроп)
*   Регулировать скорости сдвига (считывания)
*   Получить информацию о статусе камеры (съёмка, температура)
*   Завершить работу программы

Подробнее с синтаксисом команд можно ознакомиться в разделе **Команды**. 
Программа может обработать только одну команду за раз и только при
корректном синтаксисе.  Любые неверно переданные команды будут
игнорироваться с выдачей сообщения об ошибке 'ERROR STATUS=BAD_COMMAND'. 
При передаче комманды `EXIT` запускается процедура завершения работы
программы и обработка команд пользователя прекращается.

### Завершение работы
После получения команды завершения работы программа отключает TCP-сервер и 
перестаёт реагировать на команды пользователя. Затем программа плавно нагревает 
камеру до максимально возможной температуры охлаждающего элемента (около 
-10°C), чтобы избежать теплового шока матрицы. По достижении желаемой 
температуры камера отключается от программы. После этого в лог-файл пишется 
информация о выключении программы и программа закрывается.

**Внимание! Выключение и нагрев камеры должны выполняться только по согласованию с ответственным за прибор.
Нормальный режим работы и ожидания камер спектрографа - в холодном (рабочем)
состоянии.**

## Файл конфигурации
После подключения к камере программа будет производить поиск конфигурационного 
файла, соответствующего этой камере. Для того, чтобы файл был успешно найден и 
обработан он должен соответствовать следующим условиям:
*    Конфигурационный файл лежит в той же папке, что и сама программа.
*    Файл имеет расширение *.ini*.
*    Имя файла соответсвует имени камеры.
*    Каждая строчка файла является корректной командой демону

Пример корректного названия файла: "DU940P_BU.ini". Конфигурационный файл
содержит первичные команды камере, как правило это назначение номера 
ТСР-порта, по которому программа будет получать команды, тип данных
для хранения изображений в fits-файле, начальная температура
и список ключей-значений, которые будут записаны в заголовки 
всех фитс-файлов текущей сессии, если пользователь не изменит их по ходу
работы программы. Пример файла:
```
PORT 1212
PREF TDSB
TYPE uint16
TEMP -10
DIR ./data/
HEAD ORIGIN "SAI MSU" Institution name
HEAD f LONGITUD 42.6675 [deg] telescope geodetic longitude, eastward
HEAD x CALBWVNM
```
Каждая комманда записывается на отдельной строке, знаков препинаний 
в конце строки быть не должно.

## Команды
Команды программе можно передавать или в конфигурационном файле 
(выполняются один раз в начале работы программы), или как сообщения
через TCP-протокол. Во втором случае после выполнения команды
программа возвращает ответ в формате ```OK [PARAM1=VAL1 [PARAM2=VAL2]...]```, если команда
выполнена успешно, или ```ERROR STATUS=STATUS_ID```, если при выполнении
произошла ошибка. В любом случае делается соответствующая запись в лог-файл.
Если команде, устанавливающей значение, не передавать аргументов,
она возвращает текущую величину этого значения.

### Указание номера порта для запуска TCP-сервера
*Эта команда работает только из файла конфигурации!*
```
PORT portNumber
```
portNumber - целое число, номер порта на котором будет идти общение с демоном

Не рекомендуется указывать порты, зарезервированные другими службами:
[список](https://en.wikipedia.org/wiki/List_of_TCP_and_UDP_port_numbers)
Если порт не указать в *.ini* файле, будет использован порт 1567.

### Указание типа данных в fits-файле
*Эта команда работает только из файла конфигурации!*
```
TYPE dataType
```
dataType - строка (без кавычек): "uint16", "uint32", "int16", "int32", "float"

Тип данных по умолчанию - uint16 (беззнаковый целочисленный 16-битный)

### Установка температуры охлаждающего элемента
```
TEMP desiredTemperature
```
desiredTemperature - целое отрицательное число, желаемая температура камеры

У каждой камеры Andor есть свой диапазон рабочих температур, указанный в описании.
Если желаемая температура выше максимальной поддерживаемой, будет установлена максимальная.
Если ниже - минимальная.

### Скорость считывания данных
```
SPEED N|MAX|MIN
```
Аргумент команды или N - целое число, номер скорости считывания;
или строка "MAX" или "MIN" (без кавычек)

Позволяет установить, соответственно, конкретный номер скорости оцифровки
из доступных в камере, максимальную скорость или минимальную скорость
оцифровки. В камере Newton скорость 0 отвечает за частоту оцифровки 50кГц, 1 - за 1
МГц, а 2 - за 3 МГц. 

Аналогично, команда
```
VSPEED N|MAX|MIN
```
Аргумент команды или N - целое число, номер скорости считывания;
или строка "MAX" или "MIN" (без кавычек)

позволяет установить, соответственно, конкретный номер скорости
вертикального сдвига в матрице из доступных в камере, максимальную скорость или минимальную скорость
сдвига.

### Бинирование и кроп
```
BIN X Y 
```
X, Y - целые положительные числа

Устанавливает бинирование в X пикселов по горизонтали и Y пикселов по
вертикали. Если X или Y не укладываются целое число раз в соответсвующий
размер рабочей области матрицы, команда может сработать некорректно.
По умолчанию стоят X=Y=1.

Команда
```
CROP xmin ymin xmax ymax
```
Все аргументы - целые положительные значения

Задаёт границы кадра на матрице.
Не всегда корректно работает вместе с бинированием.

### Префиксы и суффиксы имён файлов
```
PREF PPP
```
и
```
SUFF SSS
```
Где PPP и SSS - строки (без кавычек), устанавливаемые как префикс и суффикс соответственно

Эти команды (можно использовать независимо) устанавливают префикс и суффикс
 имени файла данных (префикс - начало имени файла, суффикс
стоит в имени файла после времени создания и до расширения).

### Смена каталога записи данных
```
DIR dirName
```
dirName - строка (без кавычек)

меняет папку, в которую сохраняются файлы.  ОДНАКО ПАПКА ДОЛЖНА УЖЕ
СУЩЕСТВОВАТЬ! В случае отсутствия папки в лог выводится сообщение Error
while saving fits. В ini-файлах по умолчанию записано сохранять файлы в папку
data, которая лежит внутри каталога разработки (TDS_NEW).

### Регулировка режима работы затвора

Камеры Андор имеют три режима работы затвора: затвор постоянно открыт, 
постоянно закрыт или находится в автоматическом режиме, открываясь только на 
время экспозиции. Для выбора режима работы затвора используется команда
```
SHTR N
```
N - целое число (0, 1 или 2)

Команда переведёт затвор в соответствующий режим. Каждому из режимов соответствует 
цифра: 0 - автоматический, 1 - открыть, 2 - закрыть.

### Добавление строк в заголовок фитс-файла
Строка в заголовке (header) фитс-файла состоит из трёх элементов: ключ, 
значение, комментарий. Добавление новой строки в заголовки фитс-файлов 
последующей сессии осуществляется командой
```
HEAD [type] KEYNAME KEYVALUE [COMMENT TEXT]
```
Эта команда добавит во все последующие фитс-файлы изображений строку с ключом *KEYNAME*, 
значением *KEYVALUE* и комментарием *COMMENT TEXT*. Комментарий и значение опциональны, 
программа примет команду и без них.

Тип type может быть i, f, d, s, nили x (строчная буква).  Первые четыре типа
обозначают тип ключа как integer, float, double и string соответственно.
Тип n - это обозначение ключа, которому ещё не задано значение.
Тип x - команда удаления соответствующего ключа из заголовка.

KEYNAME - одно слово латиницей, пробелов не предполагает.

Значение KEYVALYE - соответствующее значение ключа.  Будте внимательны, если
тип i, а вы передаёте дробное число, ключ записан не будет (исправлю в
дальнейших версиях).  Если значение строковое и содержит пробелы, то эта
строка должна быть заключена в двойные кавычки.  Если в качестве значения
передать 'nan', согласно стандарту после знака = строка будет пустая.

Комментарий COMMENT TEXT - любое количество символов, может включать
пробелы, кавычки уже не требуются.

Примеры корректных команд:
```
HEAD i KEY1 42
HEAD f KEY2 36.6 Comment
HEAD s KEY3 "LONG VALUE" Long comment
HEAD d KEY4 nan
```
ВАЖНО!!! В ini-файл можно тоже записать ключи и с новым форматом команды
удалять старые.  В массиве ini-файле для этого необходимо добавить
строки типа "HEAD x SHAMROCK"

### Получение кадра
```
IMAG [time]
```
time - дробное или целое положительное число, выдержка в секундах.  При
отсутствии аргумента времени для экспозиции берётся предыдущее установленное
значение.  Ответ на команду поступит примерно через 1 секунду и будет
содержать
```
OK FILE=path_and_name_of_fits EXPTIME=duration STATUS=ACQUIRING
```
При ошибке установок параметров будет выведено 
```
ERROR STATUS=err_status_text
```
После передачи команды ```IMAGE``` начинается съёмка, вплоть до конца съёмки
можно добавлять ключи-значения в заголовок fits-файла.  По завершении
экспозиции будет записан файл с указанным выше именем и выдано сообщение: OK
STATUS=IDLE. 

Если же запись файла в текущий каталог не удалась, будет выдано сообщение об
ошибке ERROR STATUS=P1INVALID и, если удалась запись бэкап-файла,
```
ERROR STATUS=P1INVALID FILE=BACKUP.fits
```
Если полученный файл ценный, его нужно переименовать вручную, т.к. 
бэкап-файлы перезаписываются.

### Досрочное завершение съёмки
```
ABORT
```
Эта команда прерывает текущую съёмку, если она идёт. Накопленные данные не сохраняются.

### Получение информации о состоянии камеры
```
GET STATUS
```
Возвращает текущий статус камеры (IDLE во время ожидания, ACQUIRING во время
съёмки)

```
GET TCCD
```
Возвращает текущую температуру камеры.

```
GET TIME
```
Возвращает время, оставшееся до конца экспозиции.

### Завершение программы
Команда `EXIT`

Последует отключение сокет-соединения, отключение охлаждения и
контролируемый нагрев камеры, после чего демон завершит работу.
**Внимание! Выключать камеру только по согласованию с ответственным за
прибор!**
