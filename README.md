### andor-cameras
# Управление камерами КГО.

## Общее описание
Данная программа создана с целью облегчить написание системы управления 
приборами Кавказской Горной Обсерватории (в частности - 60см телескопом и 
двухканальным спектрографом на 2.5-метровом телескопе). Программа берёт на 
себя управление камерами Андор, а именно:

*   Инициализация камеры с заданными параметрами
*   Постоянный мониторинг и запись в файл состояния камеры
*   Контроль температурного режима камеры
*   Контроль затвора камеры
*   Контроль получения камерой изображения
*   Настройка результирующих fits-файлов

Программа работает как демон, общение с программой осуществляется через TCP 
протокол. Всё время выполнения программа ведёт лог с подробным описанием всех 
действий и событий. В данный момент программа поддерживает только операционные 
системы семейства linux.


## Использование программы
### Подготовка к запуску

Создайте *.ini* файл с параметрами запуска программы.  Файл должен быть
написан в соответствии с стандартами библиотеки *libconfig* (подробнее в
разделе **Файл конфигурации**).  Имя файла должно соответствовать имени
подключённой камеры.  В нём должны быть указаны номер порта, на котором
будет запущен TCP сервер, а также, если это требуется, постоянные значения
шапки сохраняемых в дальнейшем fits-файлов.

Перед запуском программы следует убедиться, что желаемый TCP порт свободен,
камера подключена и распознаётся компьютером.

### Работа с программой
После того, как выполнены все требования, описанные в предыдущем разделе, 
можно запустить программу из терминала, перейдя в папку с программой и набрав 
в терминале
```
./andor-daemon
``` 
Через пару секунд программа выведет в терминал сообщение с PID
созданного демона и перейдёт в режим демона.  Первые секунды работы
программы стоит просматривать лог-файл (создаётся автоматически с
расширением *.log*) на предмет ошибок.  Если всё прошло успешно, лог-файл
будет содержать строку "*Waiting for user command...*".  Обычно запуск
программы занимает около 5 секунд.  В это время происходит инициализация
камеры, запуск TCP сервера, создание шаблонного заголовка fits-файла,
считывание информации о состоянии камеры и запись этой информации в *.info*
файл.  Если к компьютеру подключены несколько камер, определить к какой
именно из них подключилась программа также можно в лог-файле.

После того, как программа перешла в режим ожидания команды пользователя, с
нею возможно общение по TCP протоколу на заданном порту.  В настоящий момент
возможны следующие команды:

*   Запустить съёмку с заданной выдержкой
*   Добавить строку в заголовок fits-файла
*   Задать желаемую температуру камеры
*   Изменить режим затвора (автоматический/закрытый/открытый)
*   Обновить файл с состоянием камеры
*   Завершить работу программы

Подробнее с синтаксисом команд можно ознакомиться в разделе **Команды**. 
Программа может обработать только одну команду за раз и только при корректном 
синтаксисе. Любые неверно переданные команды будут игнорироваться. При 
передаче комманды `EXIT` запускается процедура завершения работы программы.

### Завершение работы
После получения команды завершения работы программа отключает TCP-сервер и 
перестаёт реагировать на команды пользователя. Затем программа нагревает 
камеру до максимально возможной температуры охлаждающего элемента (около 
-10°C), чтобы избежать теплового шока матрицы. По достижении желаемой 
температуры камера отключается от программы. После этого в лог-файл пишется 
информация о выключении программы и программа закрывается.

## Файл конфигурации
После подключения к камере программа будет производить поиск конфигурационного 
файла, соответствующего этой камере. Для того, чтобы файл был успешно найден и 
обработан он должен соответствовать следующим условиям:
*    Конфигурационный файл лежит в той же папке, что и сама программа.
*    Файл имеет расширение *.ini*.
*    Имя файла соответсвует имени камеры.
*    Синтаксис файла соответствует стандартам библиотеки *libconfig*.

Пример корректного названия файла: "DU940P_BU.log". Конфигурационный файл 
содержит два элемента: номер ТСР-порта, по которому программа будет получать 
команды, **Port** и список ключей-значений, которые будут записаны в заголовки 
всех фитс-файлов текущей сессии, **Header**. Пример файла:
```
Port = 1212;
Header:
("KEY VALUE COMMENT"
 "OBS \"CMO SAI\"",
 "NAMECAM ANDOR");
```
Номер ТСР-порта указывается после конструкции "Port = " и после него ставится 
точка с запятой. Пары ключ-значение для заголовков фитс-файлов указываются 
через запятую, в двойных кавычках, внутри кавычек ключ, значение и (
опционально) комментарий разделяются пробелом. Первое слово в кавычках - ключ, 
второе - значение (запишется в фитс-файл как строка), третье, если указано, - 
комментарий. Список ключей-значений находится внутри круглых скобок, идущих 
после конструкции "Header:". После закрывающейся круглой скобки также ставится 
точка с запятой. Рекомендуется указанное в примере разбиение файла 
конфигурации на строки.

## Команды
### Установка температуры охлаждающего элемента
Температуру охлаждающего элемента можно установить командой `TEMP`, например
```
TEMP -70
```

установит целевую температуру охлаждающего элемента на -70 градусов Цельсия. 
Диапазон рабочих температур указан в описании каждой конкретной камеры. 
Число, обозначающее целевую температуру не должно быть дробным.

### Скорость считывания и бинирование данных
Команда
```
SPEED N|MAX|MIN
```
позволяет установить, соответственно, конкретный номер скорости оцифровки
из доступных в камере, максимальную скорость или минимальную скорость
оцифровки. В камере Newton скорость 0 отвечает за частоту оцифровки 50кГц, 1 - за 1
МГц, а 2 - за 3 МГц. 

Аналогично, команда
```
VSPEED N|MAX|MIN
```
позволяет установить, соответственно, конкретный номер скорости
вертикального сдвига в матрице из доступных в камере, максимальную скорость или минимальную скорость
сдвига.
 
Команда 
```
BIN X Y 
```
устанавливает бинирование в X пикселов по горизонтали и Y пикселов по
вертикали. По умолчанию стоят X=Y=1.

### Префиксы и суффиксы имён файлов

Команды 
```
PREF PPP
```
и
```
SUFF SSS
```
устанавливают префикс и суффикс имени файла данных, соответственно (суффикс
стоит в имени файла после времени создания и до расширения). Эти команды
могут быть прописаны в ini-файле с ключевыми словами Prefix и Postfix.

### Смена каталога записи данных

Команда
```
DIR
```
меняет папку, в которую сохраняются файлы.  ОДНАКО ПАПКА ДОЛЖНА УЖЕ
СУЩЕСТВОВАТЬ! В случае отсутствия папки в лог выводится сообщение Error
while saving fits. В ini-файлах по умолчанию записано сохранять файлы в папку
data (ключевое слово Dir), которая лежит внутри каталога разработки (TDS_NEW).

### Регулировка режима работы затвора

Камеры Андор имеют три режима работы затвора: затвор постоянно открыт, 
постоянно закрыт или находится в автоматическом режиме, открываясь только на 
время экспозиции. Для выбора режима работы затвора используется команда `SHTR`, 
например
```
SHTR 0
```
переведёт затвор в автоматический режим. Каждому из режимов соответствует 
цифра: 0 - автоматический, 1 - открыть, 2 - закрыть.

### Добавление строк в заголовок фитс-файла
Строка в заголовке (header) фитс-файла состоит из трёх элементов: ключ, 
значение, комментарий. Добавление новой строки в заголовки фитс-файлов 
последующей сессии осуществляется командой `HEAD`, например
```
HEAD [type] KEYNAME KEYVALUE [COMMENT TEXT]
```
добавит во все последующие фитс-файлы изображений строку с ключом *KEYNAME*, 
значением *KEYVALUE* и комментарием *COMMENT TEXT*. Комментарий опционален, 
программа поймёт команду и без него.

Тип type может быть i, f, d, s или x (строчная буква).  Первые четыре типа
обозначают тип ключа как integer, float, double и string соответственно. 
Последний "тип" - команда удаления соответствующего ключа из заголовка.

KEYNAME - одно слово латиницей, пробелов не предполагает.

Значение KEYVALYE - соответствующее значение ключа.  Будте внимательны, если
тип i, а вы передаёте дробное число, ключ записан не будет (исправлю в
дальнейших версиях).  Если значение строковое и содержит пробелы, то эта
строка должна быть заключена в двойные кавычки.

Комментарий COMMENT TEXT - любое количество символов, может включать
пробелы, кавычки уже не требуются.

Примеры корректных команд:

HEAD i KEY1 42
HEAD f KEY2 36.6 Comment
HEAD s KEY3 "LONG VALUE" Long comment

ВАЖНО!!! В ini-файл можно тоже записать ключи и с новым форматом команды
удалять старые.  В массиве Header ini-файла для этого необходимо добавить
строки типа "x SHAMROCK"

### Получение кадра
Начало экспозиции задаётся командой `IMAG`. Помимо имени комнды передаётся 
время выдержки в секундах:
```
IMAG 0.03
```
### Завершение программы
Команда `EXIT`

Последует отключение охлаждения и контролируемый нагрев камеры, после чего
демон завершит работу.
